<?xml version="1.0" encoding="UTF-8"?>
<!-- Sql Mapper -->
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="sh">
	<select id="getAllList" resultType="careDTO" parameterType="hashmap">
	SELECT 	j.rnum, j.boardNo, ca.category_name as categoryName, j.title, j.hits,
			j.wdate, j.id
	FROM	(SELECT b.board_no as boardNo, row_number() over (order by b.board_no desc) as rnum, 
			b.title, b.hits, b.wdate,b.category_no, b.id
			FROM board b, carer c 
			WHERE b.board_no = c.board_no) j, category ca
	WHERE j.category_no = ca.category_no and rnum between #{startRNum} and #{endRNum} order by rnum asc
     
	</select>

	<select id="selectAuthorityById" resultType="string">
		SELECT category_no
		FROM tier
		WHERE id=#{value}
	</select>

	<select id="selectDogById" parameterType="string" resultType="dogDTO">
		SELECT d.dog_no as dogNo, d.name, trunc(months_between(sysdate,
		d.bdate)/12)+1 as bdate,
		d.intro, d.id, i.img_path as imgPath,
		c.category_name as gender
		FROM dog d, img i, category c
		WHERE
		d.id=#{value} and d.img_no=i.img_no and
		c.category_no=d.category_no
	</select>

	<!-- careDetail -->
	<select id="careDetailDate" parameterType="int" resultType="dateDTO">
		SELECT to_char(ga.meeting_start, 'yyyy.mm.dd') as meetingStart,
		to_char(ga.meeting_end, 'yyyy.mm.dd') as meetingEnd,
		to_char(ga.gathering_start, 'yyyy.mm.dd') as gatheringStart,
		to_char(ga.gathering_end, 'yyyy.mm.dd') as gatheringEnd
		FROM carer c,
		gatheringdate ga
		WHERE c.date_no=ga.date_no and c.board_no=#{value}
	</select>
	<resultMap id="careDetailInfo" type="careDTO">
		<result property="boardNo" column="boardNo" />
		<collection property="date" column="boardNo" javaType="com.sixidiot.doingtogether.model.dto.DateDTO" 
			ofType="dateDTO" select="careDetailDate"></collection>
		<collection property="replyList" column="boardNo" javaType="java.util.ArrayList"
			ofType="replyDTO" select="careReplyList"></collection>
	</resultMap>
	
	<select id="careReplyList" parameterType="int" resultType="replyDTO">
		select reply_no as replyNo, id, content from reply where board_no=#{value}
	</select>
	
	<select id="careDetail" parameterType="int" resultMap="careDetailInfo">
		SELECT
		b.board_no as boardNo, b.title, b.id, b.hits, b.content, b.wdate,
		c.place,
		ga.gathering_start as gatheringStart, ga.gathering_end as gatheringEnd,
		ga.meeting_start as meetingStart, ga.meeting_end as meetingEnd
		FROM board b, carer c,
		gatheringdate ga
		WHERE b.board_no=c.board_no and b.board_no=#{value}
		and c.date_no=ga.date_no
	</select>

	<!-- 돌보미게시글 등록 -->
	<insert id="insertCarerBoardList" parameterType="careDTO">
		<selectKey keyProperty="boardNo" resultType="int" order="BEFORE">
			select board_seq.nextval from dual
		</selectKey>
		insert into board(board_no,title,content,wdate,category_no,id)
		values(#{boardNo},#{title},#{content},sysdate,#{categoryNo},#{id})
	</insert>
	<insert id="insertCarerDate" parameterType="dateDTO">
		<selectKey keyProperty="dateNo" resultType="int" order="BEFORE">
			select gatheringdate_seq.nextval from dual
		</selectKey>
		insert into
		gatheringdate(date_no,gathering_start,gathering_end,meeting_start,meeting_end)
		values(#{dateNo},#{gatheringStart},#{gatheringEnd},#{meetingStart},#{meetingEnd})
	</insert>
	<insert id="insertCarerWrite" parameterType="careDTO">
		insert into
		carer(board_no,date_no,place)
		values(#{boardNo},gatheringdate_seq.currval,#{place})
	</insert>

	<!-- 돌보미 글삭제 -->
 	<select id="selectDateByBoardNo" parameterType="int" resultType="int">
 		select date_no as dateNo from carer where board_no=#{value}
 	</select>

	<delete id="deleteBoardByBoardNo" parameterType="int">
		delete from board where board_no=#{value}
	</delete>
	
	<delete id="deleteGatheringDateByBoardNo" parameterType="int">
		delete from gatheringdate where date_no=#{value}
	</delete>

	<!-- 돌보미 수정 -->
	<update id="updateCareBoard" parameterType="CareDTO">
		update board set title=#{title},content=#{content} where board_no=#{boardNo}
	</update>
	<update id="updateCare" parameterType="CareDTO">
		update carer set place=#{place} where board_no=#{boardNo}
	</update>
	<update id="updateCareDate" parameterType="dateDTO">
		update gatheringdate set gathering_start=#{gatheringStart}, gathering_end=#{gatheringEnd},
		                         meeting_start=#{meetingStart}, meeting_end=#{meetingEnd} 
		where date_no=#{dateNo}
	</update>
	
	<!-- 페이징 -->
	<select id="getTotalCountCare" resultType="int">
		select count(*) from carer
	</select>
</mapper>
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
















